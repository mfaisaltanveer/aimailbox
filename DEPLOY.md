# Deploying Aimailbox to Render

This guide will walk you through deploying your Aimailbox application to Render.

## Prerequisites

1. A [Render account](https://render.com) (free tier works)
2. Your code pushed to a Git repository (GitHub, GitLab, or Bitbucket)
3. Google OAuth credentials (client ID and secret)
4. OpenAI API key

## Step 1: Prepare Your Repository

Make sure all deployment files are committed and pushed to your Git repository:

```bash
git add .
git commit -m "Add Render deployment configuration"
git push origin main
```

## Step 2: Create a New Web Service on Render

1. Log in to [Render Dashboard](https://dashboard.render.com/)
2. Click "New +" button and select "Blueprint"
3. Connect your Git repository
4. Render will automatically detect the `render.yaml` file

## Step 3: Configure Environment Variables

After the blueprint is created, you'll need to set the following environment variables in the Render dashboard:

### Required Environment Variables

Go to your web service settings and add these environment variables:

1. **GOOGLE_CLIENT_ID**
   - Your Google OAuth client ID
   - Get it from [Google Cloud Console](https://console.cloud.google.com/apis/credentials)

2. **GOOGLE_CLIENT_SECRET**
   - Your Google OAuth client secret
   - Get it from Google Cloud Console

3. **OPENAI_API_KEY**
   - Your OpenAI API key
   - Get it from [OpenAI Platform](https://platform.openai.com/api-keys)

4. **PHX_HOST**
   - Set this to your Render URL (e.g., `aimailbox.onrender.com`)
   - Update this after you know your Render URL

### Auto-Generated Variables

These are automatically generated by Render (don't set them manually):
- `DATABASE_URL` - PostgreSQL connection string
- `SECRET_KEY_BASE` - Phoenix secret key
- `CLOAK_KEY` - Encryption key
- `PORT` - Server port (10000)

## Step 4: Update Google OAuth Redirect URIs

After deployment, you need to add your Render URL to Google OAuth settings:

1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Select your OAuth 2.0 Client
3. Add to **Authorized redirect URIs**:
   ```
   https://your-app-name.onrender.com/auth/google/callback
   ```
4. Add to **Authorized JavaScript origins**:
   ```
   https://your-app-name.onrender.com
   ```
5. Click "Save"

## Step 5: Deploy

1. Render will automatically deploy when you push to your main branch
2. The first deployment will take 5-10 minutes
3. Watch the deployment logs in the Render dashboard

## Step 6: Run Migrations

After the first deployment completes:

1. Go to your web service in Render dashboard
2. Click on "Shell" tab
3. Run the migration command:
   ```bash
   /app/bin/migrate
   ```

Alternatively, migrations should run automatically during the build process.

## Step 7: Verify Deployment

1. Visit your Render URL (e.g., `https://your-app-name.onrender.com`)
2. Click "Sign in with Google"
3. Authorize the application
4. You should be redirected to the dashboard

## Troubleshooting

### Database Connection Issues

If you see database connection errors:
- Check that `DATABASE_URL` is set correctly
- Verify the database is running in Render dashboard
- Check the logs for specific errors

### OAuth Redirect Mismatch

If OAuth fails with redirect URI mismatch:
- Verify `PHX_HOST` matches your Render URL
- Check Google OAuth settings have the correct redirect URI
- Make sure you're using HTTPS URLs

### Build Failures

If the build fails:
- Check the build logs in Render dashboard
- Verify all dependencies are in `mix.exs`
- Make sure `Dockerfile` is correct

### Environment Variable Issues

If you see missing environment variable errors:
- Verify all required variables are set in Render dashboard
- Check variable names match exactly (case-sensitive)
- Restart the service after adding variables

## Updating Your Application

To deploy updates:

```bash
git add .
git commit -m "Your update message"
git push origin main
```

Render will automatically detect the push and redeploy.

## Free Tier Limitations

On Render's free tier:
- Web services spin down after 15 minutes of inactivity
- First request after spin-down takes 30-60 seconds
- Database is limited to 90 days
- 750 hours/month of runtime

## Upgrading to Paid Plans

For production use, consider upgrading:
- **Starter plan** ($7/month) - No spin-down, faster builds
- **Database** ($7/month) - Persistent database beyond 90 days

## Support

For issues:
- Check [Render Documentation](https://render.com/docs)
- Review application logs in Render dashboard
- Check Phoenix logs for application-specific errors

## Security Checklist

Before going to production:

- [ ] All environment variables use Render's encrypted storage
- [ ] `SECRET_KEY_BASE` is using Render's generated value
- [ ] Google OAuth is configured for production domain
- [ ] SSL/HTTPS is enabled (automatic on Render)
- [ ] Database backups are configured
- [ ] Monitor application logs regularly

## Monitoring

Monitor your application:
- View logs in Render dashboard
- Set up Render notifications for deployment failures
- Monitor database usage
- Check application metrics

## Cost Optimization

Tips for managing costs:
- Use free tier for development/testing
- Upgrade database first (data persistence)
- Consider upgrading web service if spin-down is problematic
- Monitor usage to avoid overages

---

**Note**: Remember to never commit sensitive credentials to your repository. Always use environment variables for secrets.
